---
title: "Pi Setup"
description: "Setting up a pi with security, docker and more"
pubDate: "5/4/2024"
heroImage: "/blog-placeholder-3.jpg"
---

```sh
ssh USER_NAME@IP_ADDRESS
```

## Update and reboot

```sh
sudo apt update && sudo apt upgrade
```

```sh
sudo reboot
```

## Mount external HDD

### Check where it is mounted

```sh
lsblk
```

### Get UUID

```sh
sudo blkid /dev/sda1
```

### Create mount location

```sh
sudo mkdir -p /mnt/flex
```

### Change ownership

```sh
sudo chown -R $USER:$USER /mnt/flex
```

```sh
sudo chmod -R 755 /mnt/flex
```

### Modify fstab

```sh
sudo nano /etc/fstab
```

### Replace current

```sh
UUID=22d23d78-272d-4d51-9168-3ac30bfb6353  /mnt/flex       ext4            auto,nofail,noatime,rw,users  0    0
```

### Unmount drive

```sh
sudo umount /dev/sda1
```

### Reboot

```sh
sudo reboot
```

## Docker

```sh
sudo apt install ca-certificates curl
```

```sh
sudo install -m 0755 -d /etc/apt/keyrings
```

```sh
sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
```

```sh
sudo chmod a+r /etc/apt/keyrings/docker.asc
```

```sh
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

```sh
sudo apt update
```

```sh
sudo apt remove docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

```sh
sudo apt purge docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

```sh
sudo rm -rf /var/lib/docker && sudo rm -rf /var/lib/containerd
```

```sh
sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

```sh
sudo groupadd docker
```

```sh
sudo usermod -aG docker $USER
```

```sh
sudo reboot
```

```sh
mkdir next-cloud-config
```

```sh
cd next-cloud-config && sudo nano .env
```

```sh
MYSQL_HOST=
MYSQL_DATABASE=
MYSQL_ROOT_PASSWORD=
MYSQL_USER=
MYSQL_PASSWORD=
```

```sh
sudo nano docker-compose.yml
```

```yml
services:
  nextcloud:
    image: lscr.io/linuxserver/nextcloud
    container_name: nextcloud
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - /mnt/flex/appdata/nextcloud/config:/config
      - /mnt/flex/appdata/nextcloud/data:/data
    ports:
      - 9000:80
    depends_on:
      - mariadb
    restart: unless-stopped
  mariadb:
    image: lscr.io/linuxserver/mariadb
    container_name: mariadb
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - /mnt/flex/appdata/mariadb:/config
    restart: unless-stopped
  nginx:
    image: "jc21/nginx-proxy-manager:latest"
    container_name: nginx
    volumes:
      - /mnt/flex/appdata/nginx/data:/data
      - /mnt/flex/appdata/nginx/letsencrypt:/etc/letsencrypt
    ports:
      - 443:443
      - 80:80
      - 81:81
    restart: unless-stopped
```

[Cloudflare tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/get-started/create-local-tunnel)

```sh
docker compose up -d
```

## Portainer

```sh
docker pull portainer/portainer-ce:linux-arm64-2.0.0
```

```sh
docker volume create --opt device=/mnt/flex portainer_data
```

### Start portainer

```sh
docker run -d -p 9000:9000 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce:linux-arm64-2.0.0
```

### Access web UI

http://PI_IP_ADDRESS:9000

## Security

1. Keep system updated

```sh
sudo apt install unattended-upgrades
```

```sh
sudo nano /etc/apt/apt.conf.d/02periodic
```

### Add this

```sh
APT::Periodic::Enable "1";
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Download-Upgradeable-Packages "1";
APT::Periodic::Unattended-Upgrade "1";
APT::Periodic::AutocleanInterval "1";
APT::Periodic::Verbose "2";
```

```sh
sudo unattended-upgrades -d
```

2. Make sudo require password

```sh
sudo nano /etc/sudoers.d/010_pi-nopasswd
```

### Find this line and change

pi ALL=(ALL) NOPASSWD: ALL => Remove NO, "PASSWD: ALL"

3. SSH: prevent root login

```sh
sudo nano /etc/ssh/sshd_config
```

### Find this line and uncomment

\#PermitRootLogin prohibit-password

### Restart the SSH server if you changed anything in the configuration file:

```sh
sudo service ssh restart
```

4. SSH: change port

```sh
sudo nano /etc/ssh/sshd_config
```

### Change port on this line

\#Port 22

5. SSH: use keys instead of password

### HOST: Create key

```sh
ssh-keygen -t rsa
```

### HOST: Copy public key to Pi

```sh
scp ~/.ssh/id_rsa.pub USER_NAME@DEVICE_IP:~/.ssh/id_rsa.pub
```

### PI: Add key to the allowed keys

```sh
cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
```

### PI: Edit config to disallow password

```sh
sudo nano /etc/ssh/sshd_config
```

PasswordAuthentication no

6. Install fail2ban

```sh
sudo apt install fail2ban
```

### Optional update config

```sh
sudo nano /etc/fail2ban/jail.conf
```

### Restart the service if you change anything

```sh
sudo service fail2ban restart
```

7. Install firewall

```sh
sudo apt install ufw
```

### Example limit access to port by ip

```sh
sudo ufw allow from IP_ADDRESS port PORT_NUMBER
```

```sh
sudo ufw enable
```
